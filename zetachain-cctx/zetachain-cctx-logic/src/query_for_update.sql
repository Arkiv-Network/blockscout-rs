WITH selected AS ( SELECT cctx.ctid, cctx.id FROM cross_chain_tx cctx JOIN cctx_status cs ON cctx.id = cs.cross_chain_tx_id WHERE cctx.processing_status = 'Unlocked'::processing_status AND cctx.last_status_update_timestamp + CASE WHEN cctx.retries_number = 0 THEN INTERVAL '0 milliseconds' WHEN cctx.retries_number = 1 THEN INTERVAL '$1 milliseconds' WHEN cctx.retries_number = 2 THEN INTERVAL '$1 milliseconds' * 3 WHEN cctx.retries_number = 3 THEN INTERVAL '$1 milliseconds' * 7 WHEN cctx.retries_number = 4 THEN INTERVAL '$1 milliseconds' * 15 WHEN cctx.retries_number = 5 THEN INTERVAL '$1 milliseconds' * 31 WHEN cctx.retries_number = 6 THEN INTERVAL '$1 milliseconds' * 63 WHEN cctx.retries_number = 7 THEN INTERVAL '$1 milliseconds' * 127 WHEN cctx.retries_number = 8 THEN INTERVAL '$1 milliseconds' * 255 WHEN cctx.retries_number = 9 THEN INTERVAL '$1 milliseconds' * 511 ELSE INTERVAL '$1 milliseconds' * 1023 END < NOW() ORDER BY cs.last_update_timestamp DESC LIMIT $2 FOR UPDATE OF cctx SKIP LOCKED ) UPDATE cross_chain_tx AS cctx SET processing_status = 'Locked'::processing_status, last_status_update_timestamp = NOW(), retries_number = cctx.retries_number + 1 FROM selected WHERE cctx.ctid = selected.ctid RETURNING cctx.id, cctx.index, cctx.root_id, cctx.depth, cctx.retries_number;